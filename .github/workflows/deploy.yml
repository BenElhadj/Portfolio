name: Deploy to GitHub Pages (Vite optimized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      use_dotenv_secret:
        description: 'Set to true to write DOTENV_GITHUB_PAGES secret into .env.github-pages before loading (optional)'
        required: false
        default: 'false'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Write DOTENV secret to file (if provided)
        if: ${{ secrets.DOTENV_GITHUB_PAGES != '' }}
        run: |
          printf '%s\n' "${{ secrets.DOTENV_GITHUB_PAGES }}" > .env.github-pages

      - name: Ensure .env.github-pages exists (optional)
        run: |
          if [ -f .env.github-pages ]; then echo "Found .env.github-pages"; else echo "No .env.github-pages file"; fi

      - name: Load .env.github-pages into environment
        if: ${{ secrets.DOTENV_GITHUB_PAGES != '' || (exists('.env.github-pages')) }}
        shell: bash
        run: |
          echo "Loading .env.github-pages into GITHUB_ENV"
          # Read file line by line, ignore comments and empty lines, export to GITHUB_ENV
          while IFS= read -r line || [ -n "$line" ]; do
            # strip leading/trailing whitespace and inline comments
            line="$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/[[:space:]]*#.*$//')"
            [ -z "$line" ] && continue
            [[ "$line" != *=* ]] && continue
            name="${line%%=*}"
            value="${line#*=}"
            # remove surrounding quotes
            if [[ ("${value:0:1}" == '"' && "${value: -1}" == '"') || ("${value:0:1}" == "'" && "${value: -1}" == "'") ]]; then
              value="${value:1:-1}"
            fi
            echo "$name=$value" >> "$GITHUB_ENV"
          done < .env.github-pages

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build (Vite optimized)
        env:
          NODE_ENV: production
        run: |
          # Run Vite build in production mode. Ensure your package.json has a "build" script.
          npm run build --if-present

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download artifact
        uses: actions/download-pages-artifact@v1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4